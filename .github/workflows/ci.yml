name: Build and Deploy

on:
  push:
    tags:
      - "*"
    branches-ignore:
      - 'exp_*'
  pull_request:
    branches-ignore:
      - 'exp_*'

jobs:
  test_go:
    name: Test go-${{ matrix.go }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    # We want to run on external PRs, but not on our own internal PRs as they'll be run
    # by the push to the branch.
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    strategy:
      matrix:
        go: [ 1.24.x ]
        os: [ ubuntu-latest, macOs-latest, windows-latest ]
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 5

      - name: Setup Java (for ANTLR grammar validation)
        uses: actions/setup-java@v5.2.0
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Validate ANTLR Grammar
        run: |
          cd grammar
          make test-grammar
        shell: bash

      - name: Verify Generated Parser (optional check)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd grammar
          make generate-go
          git diff --exit-code ../internal/parser/ || {
            echo "ERROR: Generated parser files don't match grammar!"
            echo "Run 'make generate-go' in the grammar/ directory and commit the changes."
            exit 1
          }
        shell: bash

      - name: Setup go
        uses: actions/setup-go@v6.2.0
        with:
          go-version: ${{ matrix.go }}

      - name: Test
        run: go test -v ./...

  fuzz_go:
    name: Fuzz go-${{ matrix.go }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    strategy:
      matrix:
        go: [ 1.24.x ]
        os: [ ubuntu-latest ]  # Fuzz only on Linux for speed
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 5

      - name: Setup go
        uses: actions/setup-go@v6.2.0
        with:
          go-version: ${{ matrix.go }}

      - name: Run Fuzz Tests
        run: make fuzz FUZZ_TIME=30s

  release:
    name: Release
    runs-on: "ubuntu-latest"
    needs: [test_go, fuzz_go]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v6.2.0
        with:
          go-version: 1.24
      - name: Release ðŸš€
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cpp:
    name: C++ tests and docs
    runs-on: "ubuntu-22.04"
    # We want to run on external PRs, but not on our own internal PRs as they'll be run
    # by the push to the branch.
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 1

      - name: Setup dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc g++ cmake

      - name: Setup Java (for ANTLR parser verification)
        uses: actions/setup-java@v5.2.0
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Verify Generated C++ Parser
        run: |
          cd grammar
          make generate-cpp
          git diff --exit-code ../cpp/private/parser/ || {
            echo "ERROR: Generated C++ parser files don't match grammar!"
            echo "Run 'make generate-cpp' in the grammar/ directory and commit the changes."
            exit 1
          }
        shell: bash

      - name: Build and Test (CMake)
        run: |
          cd cpp
          mkdir build && cd build
          cmake ..
          make -j$(nproc)
          ./fileseq_tests

      - name: Build doxygen
        run: sudo apt-get update &&
          sudo apt install -y doxygen doxygen-doc doxygen-latex doxygen-gui graphviz &&
          cd ${GITHUB_WORKSPACE}/cpp/docs &&
          doxygen

      - name: Deploy doc ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4.8.0
        if: github.ref == 'refs/heads/master'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages # The branch the action should deploy to.
          folder: cpp/docs/build # The folder the action should deploy.
          clean: true # Automatically remove deleted files from the deploy branch
